import 'package:flutter_test/flutter_test.dart';
import 'package:http/http.dart' as http;

import 'package:hn_app/src/article.dart';

void main() {
  test('parses topstories.json', () {
    final jsonString = "[22710656,22709780,22691207,22710289,22708233,22708041,22701857,22702293,22708199,22709183,22708535,22701508,22706242,22692769,22709852,22705718,22700516,22705712,22701532,22704774,22710370,22703000,22693792,22701113,22692281,22690933,22702195,22707869,22709850,22703112,22705268,22702701,22694014,22703758,22694891,22707935,22702311,22707782,22696229,22706194,22701830,22705028,22703959,22708833,22701059,22709763,22702869,22709345,22702041,22707926,22702602,22707102,22691603,22696377,22703561,22698299,22702340,22699608,22686602,22702255,22693634,22706172,22695174,22704051,22704116,22704053,22702000,22697212,22692347,22701061,22688933,22699439,22709371,22708079,22701406,22705709,22700525,22696252,22691401,22690847,22706307,22709843,22707365,22693805,22702901,22702593,22691949,22699319,22696082,22701604,22691215,22690906,22706677,22703407,22691300,22693016,22707387,22699176,22700365,22687086,22704242,22692831,22689301,22705350,22708114,22696179,22703710,22695264,22701902,22701398,22702941,22708608,22702051,22690229,22705122,22687194,22701352,22691029,22704725,22691218,22692068,22708627,22704615,22704721,22695517,22705654,22703875,22701372,22696362,22698306,22687438,22688820,22702751,22690751,22701247,22708139,22692169,22702787,22709510,22693539,22707657,22704785,22690743,22704589,22707546,22702225,22693462,22707945,22702214,22697105,22689085,22703691,22687296,22696073,22703360,22692885,22687062,22687131,22708574,22687674,22690599,22687927,22709099,22695261,22702664,22705048,22700895,22688731,22700854,22705746,22689369,22702082,22691295,22694781,22707278,22696449,22699354,22697346,22705511,22708202,22700563,22696455,22702437,22686913,22686802,22693988,22702187,22691965,22707553,22706395,22691656,22706165,22706674,22709481,22689959,22700581,22689659,22694695,22700621,22700482,22686682,22689190,22707807,22707796,22687112,22700627,22703147,22701567,22696981,22689776,22705979,22707231,22696109,22687928,22702455,22688509,22708273,22701886,22699067,22704890,22704649,22689746,22705877,22706564,22688935,22703885,22708413,22710247,22697436,22689058,22706130,22701207,22687801,22707650,22702955,22700879,22702629,22708579,22687279,22706053,22700652,22688023,22688544,22700427,22708512,22698530,22695650,22689789,22688564,22703584,22699702,22694618,22697571,22688631,22689830,22695990,22691311,22707076,22708141,22702713,22690872,22702646,22691840,22686957,22699049,22690369,22705073,22698154,22702314,22702302,22705567,22699329,22687117,22690299,22699494,22689046,22705678,22688030,22689198,22689033,22705207,22700206,22698906,22688188,22698908,22687784,22697642,22700783,22708349,22693941,22690406,22699342,22703756,22689596,22689207,22703173,22703127,22700455,22698979,22688058,22689108,22692865,22705784,22690700,22699007,22689493,22697477,22697963,22699424,22697037,22687292,22698049,22692010,22696444,22702327,22702272,22691143,22690488,22700722,22695056,22697632,22694632,22697488,22688692,22694655,22694710,22701555,22692319,22688799,22701346,22699974,22686918,22686833,22690945,22698880,22700548,22694812,22686600,22702285,22691461,22694003,22697670,22699014,22697163,22690337,22690566,22699803,22687553,22688601,22688161,22687648,22693059,22692208,22696821,22694712,22698472,22690740,22692996,22692921,22686967,22690261,22687820,22692259,22698522,22687651,22686961,22690785,22689991,22690424,22696762,22689032,22687910,22687002,22686679,22686560,22691926,22695861,22691443,22690966,22696175,22693320,22686587,22687866,22704099,22705148,22702243,22690997,22691184,22694277,22688004,22693854,22698713,22707424,22704971,22703688]";

    expect(parseArticleIds(jsonString).first, 22710656);
  });

  test('parses item.json', () {
    final jsonString = """{"by":"dhouston","descendants":71,"id":8863,"kids":[9224,8917,8952,8884,8887,8869,8958,8940,8908,9005,8873,9671,9067,9055,8865,8881,8872,8955,10403,8903,8928,9125,8998,8901,8902,8907,8894,8870,8878,8980,8934,8943,8876],"score":104,"time":1175714200,"title":"My YC app: Dropbox - Throw away your USB drive","type":"story","url":"http://www.getdropbox.com/u/2/screencast.html"}""";

    expect(parseArticle(jsonString).by, "dhouston");
  });

  test('parses item.json over a network', () async {
    final url = 'https://hacker-news.firebaseio.com/v0/beststories.json';
    final response = await http.get(url);
    if (response.statusCode == 200) {
      final List listOfIds = parseArticleIds(response.body);
      if (listOfIds.isNotEmpty) {
        final storyUrl = 'https://hacker-news.firebaseio.com/v0/item/${listOfIds.first}.json';
        final storyResponse = await http.get(storyUrl);
        if (storyResponse.statusCode == 200) {
          final story = parseArticle(storyResponse.body);
          expect(story, isNotNull);
        }
      }
    }
  });
}